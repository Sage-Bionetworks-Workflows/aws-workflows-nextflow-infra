AWSTemplateFormatVersion: '2010-09-09'
Description: Nextflow Tower ECS template
Parameters:
  ClusterName:
    Type: String
    Description: ECS cluster name
  TowerSmtpHost:
    Type: String
    Description: SMTP server hostname
  TowerSmtpPort:
    Type: String
    Description: SMTP server port
  TowerSmtpUser:
    Type: String
    Description: SMTP server username
    NoEcho: 'true'
  TowerSmtpPassword:
    Type: String
    Description: SMTP server password
    NoEcho: 'true'
  TowerContactEmail:
    Type: String
    Description: Email for login emails
  TowerServerUrl:
    Type: String
    Description: IP address of container instance
  TowerDbUrl:
    Type: String
    Description: MySQL DB connection URL
  TowerFrontendImage:
    Type: String
    Description: Docker image for Tower frontend application
    Default: '709825985650.dkr.ecr.us-east-1.amazonaws.com/seqera-labs/nf-tower-enterprise/frontend:v20.12.4'
  TowerBackendImage:
    Type: String
    Description: Docker image for Tower backend application
    Default: '709825985650.dkr.ecr.us-east-1.amazonaws.com/seqera-labs/nf-tower-enterprise/backend:v20.12.4'
  RedisImage:
    Type: String
    Description: Redis docker image
    Default: 'redis:5.0.8'

Resources:

  TowerJwtSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub '${AWS::StackName}-TowerJwtSecret'
      Description: Secret used to generate the login JWT token. Use a long random string (35 chars or more).
      GenerateSecretString:
        PasswordLength: 128

  TowerCryptoSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub '${AWS::StackName}-TowerCryptoSecret'
      Description: Secret key used to encrypt user credentials.
      GenerateSecretString:
        PasswordLength: 128

  TowerTask:
    Type: AWS::ECS::TaskDefinition
    Properties:
      NetworkMode: bridge
      ContainerDefinitions:

        - Name: redis
          Image: !Ref RedisImage
          Memory: 2000
          Cpu: 0
          PortMappings:
            - ContainerPort: 6379
              HostPort: 6379
          Command:
            - --appendonly yes

        - Name: cron
          Image: !Ref TowerBackendImage
          Memory: 2000
          Cpu: 0
          Links:
            - redis
          DependsOn:
            - ContainerName: redis
              Condition: START
          WorkingDirectory: /work
          EntryPoint:
            - /bin/sh
          Command:
            - -c
            - /migrate-db.sh; /tower.sh
          Environment:
            - Name: TOWER_CONTACT_EMAIL
              Value: !Ref 'TowerContactEmail'
            - Name: TOWER_SMTP_HOST
              Value: !Ref 'TowerSmtpHost'
            - Name: TOWER_SMTP_PORT
              Value: !Ref 'TowerSmtpPort'
            - Name: TOWER_SMTP_USER
              Value: !Ref 'TowerSmtpUser'
            - Name: TOWER_SMTP_PASSWORD
              Value: !Ref 'TowerSmtpPassword'
            - Name: TOWER_DB_URL
              Value: !Ref TowerDbUrl
            - Name: TOWER_DB_DRIVER
              Value: com.mysql.cj.jdbc.Driver
            - Name: TOWER_DB_DIALECT
              Value: io.seqera.util.MySQL55DialectCollateBin
            - Name: TOWER_DB_USER
              Value: '{{resolve:secretsmanager:nextflow-aurora-mysql-NextflowTowerDatabaseUserSecret:SecretString:username}}'
            - Name: TOWER_DB_PASSWORD
              Value: '{{resolve:secretsmanager:nextflow-aurora-mysql-NextflowTowerDatabaseUserSecret:SecretString:password}}'
            - Name: TOWER_SERVER_URL
              Value: !Ref 'TowerServerUrl'
            - Name: MICRONAUT_ENVIRONMENTS
              Value: prod,redis,cron,aws-mktp,awsbatch-platform
            - Name: TOWER_JWT_SECRET
              Value: !Sub '{{resolve:secretsmanager:${TowerJwtSecret}:SecretString}}'
            - Name: TOWER_CRYPTO_SECRETKEY
              Value: !Sub '{{resolve:secretsmanager:${TowerCryptoSecret}:SecretString}}'
            - Name: FLYWAY_LOCATIONS
              Value: classpath:db-schema/mysql

        - Name: frontend
          Image: !Ref TowerFrontendImage
          Memory: 2000
          Cpu: 0
          Essential: false
          PortMappings:
            - ContainerPort: 80
              HostPort: 80
          Links:
            - backend
          DependsOn:
            - ContainerName: backend
              Condition: START

        - Name: backend
          Hostname: backend
          Memory: 2000
          Cpu: 0
          Image: !Ref TowerBackendImage
          PortMappings:
            - ContainerPort: 8080
              HostPort: 8080
          Essential: false
          Links:
            - redis
            - cron
          WorkingDirectory: /work
          DependsOn:
            - ContainerName: cron
              Condition: START
            - ContainerName: redis
              Condition: START
          Environment:
            - Name: TOWER_CONTACT_EMAIL
              Value: !Ref 'TowerContactEmail'
            - Name: TOWER_SMTP_HOST
              Value: !Ref 'TowerSmtpHost'
            - Name: TOWER_SMTP_PORT
              Value: !Ref 'TowerSmtpPort'
            - Name: TOWER_SMTP_USER
              Value: !Ref 'TowerSmtpUser'
            - Name: TOWER_SMTP_PASSWORD
              Value: !Ref 'TowerSmtpPassword'
            - Name: TOWER_DB_URL
              Value: !Ref TowerDbUrl
            - Name: TOWER_DB_DRIVER
              Value: com.mysql.cj.jdbc.Driver
            - Name: TOWER_DB_DIALECT
              Value: io.seqera.util.MySQL55DialectCollateBin
            - Name: TOWER_DB_USER
              Value: '{{resolve:secretsmanager:nextflow-aurora-mysql-NextflowTowerDatabaseUserSecret:SecretString:username}}'
            - Name: TOWER_DB_PASSWORD
              Value: '{{resolve:secretsmanager:nextflow-aurora-mysql-NextflowTowerDatabaseUserSecret:SecretString:password}}'
            - Name: TOWER_SERVER_URL
              Value: !Ref 'TowerServerUrl'
            - Name: MICRONAUT_ENVIRONMENTS
              Value: prod,redis,ha,awsbatch-platform,gls-platform,lsf-platform,slurm-platform
            - Name: TOWER_JWT_SECRET
              Value: !Sub '{{resolve:secretsmanager:${TowerJwtSecret}:SecretString}}'
            - Name: TOWER_CRYPTO_SECRETKEY
              Value: !Sub '{{resolve:secretsmanager:${TowerCryptoSecret}:SecretString}}'
            - Name: FLYWAY_LOCATIONS
              Value: classpath:db-schema/mysql
          EntryPoint:
            - /bin/sh
          Command:
            - -c
            - /tower.sh

  TowerService:
    Type: AWS::ECS::Service
    Properties:
      Cluster: !Ref 'ClusterName'
      DesiredCount: 1
      ServiceName: TowerService
      TaskDefinition: !Ref 'TowerTask'
      LaunchType: EC2
